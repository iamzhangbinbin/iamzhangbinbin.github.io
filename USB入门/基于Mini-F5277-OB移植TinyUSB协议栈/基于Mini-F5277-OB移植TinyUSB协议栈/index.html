
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="张彬彬的个人技术博客">
      
      
        <meta name="author" content="张彬彬">
      
      
        <link rel="canonical" href="https://iamzhangbinbin.github.io/USB%E5%85%A5%E9%97%A8/%E5%9F%BA%E4%BA%8EMini-F5277-OB%E7%A7%BB%E6%A4%8DTinyUSB%E5%8D%8F%E8%AE%AE%E6%A0%88/%E5%9F%BA%E4%BA%8EMini-F5277-OB%E7%A7%BB%E6%A4%8DTinyUSB%E5%8D%8F%E8%AE%AE%E6%A0%88/">
      
      
        <link rel="prev" href="../../">
      
      
        <link rel="next" href="../../../CAN%E5%85%A5%E9%97%A8/">
      
      
      <link rel="icon" href="../../../img/favicon.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>TinyUSB - 张彬彬的杂货铺</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
    
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="light-blue" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#tinyusb" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../.." title="张彬彬的杂货铺" class="md-header__button md-logo" aria-label="张彬彬的杂货铺" data-md-component="logo">
      
  <img src="../../../img/zahuopu.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            张彬彬的杂货铺
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              TinyUSB
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="light-blue" data-md-color-accent="indigo"  aria-label="切换至夜间模式"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="切换至夜间模式" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="切换至日间模式"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="切换至日间模式" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="分享" aria-label="分享" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/iamzhangbinbin/iamzhangbinbin.github.io" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    I'mZhangBinbin
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../MCU%E5%BC%80%E5%8F%91%E6%94%AF%E6%8C%81/" class="md-tabs__link">
          
  
  
    
  
  MCU开发支持

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../MM32%20Guide/" class="md-tabs__link">
          
  
  
    
  
  MM32 Guide

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../Python%E7%AC%94%E8%AE%B0/" class="md-tabs__link">
          
  
  
    
  
  Python笔记

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../%E6%A0%87%E5%87%86%E4%B8%8E%E8%AE%A4%E8%AF%81/" class="md-tabs__link">
          
  
  
    
  
  标准与认证

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../" class="md-tabs__link">
          
  
  
    
  
  USB入门

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../CAN%E5%85%A5%E9%97%A8/" class="md-tabs__link">
          
  
  
    
  
  CAN入门

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../ENET%E5%85%A5%E9%97%A8/" class="md-tabs__link">
          
  
  
    
  
  ENET入门

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../blog/" class="md-tabs__link">
          
  
  
    
  
  博客

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../.." class="md-tabs__link">
          
  
  
    
  
  About

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="张彬彬的杂货铺" class="md-nav__button md-logo" aria-label="张彬彬的杂货铺" data-md-component="logo">
      
  <img src="../../../img/zahuopu.png" alt="logo">

    </a>
    张彬彬的杂货铺
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/iamzhangbinbin/iamzhangbinbin.github.io" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    I'mZhangBinbin
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../../MCU%E5%BC%80%E5%8F%91%E6%94%AF%E6%8C%81/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    MCU开发支持
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../../MM32%20Guide/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    MM32 Guide
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../../Python%E7%AC%94%E8%AE%B0/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Python笔记
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../../%E6%A0%87%E5%87%86%E4%B8%8E%E8%AE%A4%E8%AF%81/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    标准与认证
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
      
        
        
      
      
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    USB入门
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5" id="__nav_5_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            USB入门
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    TinyUSB
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    TinyUSB
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      简介
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mcu" class="md-nav__link">
    <span class="md-ellipsis">
      获取MCU库函数与例程
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tinyusb_1" class="md-nav__link">
    <span class="md-ellipsis">
      获取TinyUSB协议栈
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      工程目录结构
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      配置移植接口
    </span>
  </a>
  
    <nav class="md-nav" aria-label="配置移植接口">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#usb-device" class="md-nav__link">
    <span class="md-ellipsis">
      配置USB Device接口
    </span>
  </a>
  
    <nav class="md-nav" aria-label="配置USB Device接口">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#usb" class="md-nav__link">
    <span class="md-ellipsis">
      USB 端点管理
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#usb_1" class="md-nav__link">
    <span class="md-ellipsis">
      USB 驱动使能
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#usb-device_1" class="md-nav__link">
    <span class="md-ellipsis">
      USB Device 中断
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#usb-host" class="md-nav__link">
    <span class="md-ellipsis">
      配置USB Host接口
    </span>
  </a>
  
    <nav class="md-nav" aria-label="配置USB Host接口">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      双向队列实现
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      数据库实现
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#usb_2" class="md-nav__link">
    <span class="md-ellipsis">
      USB 缓冲描述表定义
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../../CAN%E5%85%A5%E9%97%A8/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    CAN入门
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../../ENET%E5%85%A5%E9%97%A8/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    ENET入门
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../../blog/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    博客
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../.." class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    About
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="tinyusb">从零开始移植TinyUSB协议栈<a class="headerlink" href="#tinyusb" title="Permanent link">&para;</a></h1>
<div class="toc">
<ul>
<li><a href="#tinyusb">从零开始移植TinyUSB协议栈</a><ul>
<li><a href="#_1">简介</a></li>
<li><a href="#mcu">获取MCU库函数与例程</a></li>
<li><a href="#tinyusb_1">获取TinyUSB协议栈</a></li>
<li><a href="#_2">工程目录结构</a></li>
<li><a href="#_3">配置移植接口</a><ul>
<li><a href="#usb-device">配置USB Device接口</a><ul>
<li><a href="#usb">USB 端点管理</a></li>
<li><a href="#usb_1">USB 驱动使能</a></li>
<li><a href="#usb-device_1">USB Device 中断</a></li>
</ul>
</li>
<li><a href="#usb-host">配置USB Host接口</a><ul>
<li><a href="#_4">双向队列实现</a></li>
<li><a href="#_5">数据库实现</a></li>
<li><a href="#usb_2">USB 缓冲描述表定义</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<h2 id="_1">简介<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>本文将基于 Mini-F5277-OB 开发板，讲解从零开始移植Tiny USB协议栈的全过程。</p>
<p><strong>Mini-F5277-OB 开发板介绍</strong></p>
<p>Mini-F5277-OB 开发板，搭载了MM32F5270系列中 MM32F5277E7PV 型号的MCU，为32位 Arm China STAR-MC1 架构，内置 256KB Flash，192KB SRAM，并带有USB全速设备控制器，支持 12Mbps 的传输速率。在配置为 USB Host 模式下支持 12Mbps 的全速传输和 1.5 Mbps 的低速传输速率。其中 USB_FS 控制器内置 USB 全速 PHY。详情见：<a href="https://www.mindmotion.com.cn/support/development_tools/evaluation_boards/miniboard/mm32f5277e7pv/">上海灵动微电子股份有限公司 (mindmotion.com.cn)</a>官网。</p>
<p><img alt="Mini-F5277-OB" src="../image/Mini-F5277-OB.png" /></p>
<p><strong>TinyUSB 协议栈介绍</strong></p>
<p>TinyUSB 是一个应用于嵌入式系统的开源跨平台 USB Host / Device 协议栈，其优点为：</p>
<ul>
<li>
<p>MIT 开源协议，不用担心版权问题；</p>
</li>
<li>
<p>内存安全（没有动态内存分配）；</p>
</li>
<li>
<p>线程安全（所有中断事件都会放在非中断函数中处理）。</p>
</li>
</ul>
<p>如下图所示，为TinyUSB协议栈结构框图：</p>
<p><img alt="tinyusb_stack" src="../image/tinyusb_stack.png" /></p>
<center> 图x TinyUSB 协议栈框图 </center>

<p>由上图可知，TinyUSB协议栈中的Host 与 Device 是相互独立的两个协议。</p>
<p>TinyUSB 协议栈中的 Device 协议应用较为广泛，支持的 USB 类也十分丰富：</p>
<ul>
<li>Audio Class 2.0 (UAC2)</li>
<li>Bluetooth Host Controller Interface (BTH HCI)</li>
<li>Communication Class (CDC)</li>
<li>Device Firmware Update (DFU): DFU mode (WIP) and Runtinme</li>
<li>Human Interface Device (HID): Generic (In &amp; Out), Keyboard, Mouse, Gamepad etc …</li>
<li>Mass Storage Class (MSC): with multiple LUNs</li>
<li>Musical Instrument Digital Interface (MIDI)</li>
<li>Network with RNDIS, CDC-ECM (work in progress)</li>
<li>USB Test and Measurement Class (USBTMC)</li>
<li>Vendor-specific class support with generic In &amp; Out endpoints. Can be used with MS OS 2.0 compatible descriptor to load winUSB driver without INF file.</li>
<li><a href="https://github.com/WICG/webusb">WebUSB</a> with vendor-specific class</li>
</ul>
<p>而 Host 支持的类，暂时提供了两个，不过对于 MCU 的这种资源的应用而言，以下两个类足够满足大部分需求了：</p>
<ul>
<li>Human Interface Device (HID): Keyboard, Mouse, Generic</li>
<li>Mass Storage Class (MSC)</li>
</ul>
<h2 id="mcu">获取MCU库函数与例程<a class="headerlink" href="#mcu" title="Permanent link">&para;</a></h2>
<p>Mini-F5277-OB 开发板的驱动样例及原理图位于：<code>https://www.mindmotion.com.cn/support/development_tools/evaluation_boards/miniboard/mm32f5277e7pv/</code>，下载 <code>MM32F5270 库函数与例程</code>，这里我们用到了软件包中的<code>device</code>文件夹，其中包含MCU的启动文件和驱动文件。</p>
<h2 id="tinyusb_1">获取TinyUSB协议栈<a class="headerlink" href="#tinyusb_1" title="Permanent link">&para;</a></h2>
<p>TinyUSB协议栈源码下载地址：<code>https://github.com/hathach/tinyusb/releases/tag/0.16.0</code></p>
<p>本次移植是基于截止本文编写时最新版本的 TinyUSB V0.16.0 进行移植，这里我们用到了软件包 <code>tinyusb\src</code> 作为协议栈源码、 <code>tinyusb\examples</code> 文件夹中USB 样例代码和 <code>tinyusb\hw\bsp</code>文件夹中的支持的开发板源文件。 </p>
<div class="highlight"><pre><span></span><code>.
├── docs            # Documentation
├── examples        # Examples with make and cmake build system
├── hw
│   ├── bsp         # Supported boards source files
│   └── mcu         # Low level mcu core &amp; peripheral drivers
├── lib             # Sources from 3rd party such as freeRTOS, fatfs ...
├── src             # All sources files for TinyUSB stack itself.
├── test            # Tests: unit test, fuzzing, hardware test
└── tools           # Files used internally
</code></pre></div>
<h2 id="_2">工程目录结构<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>如下图x所示，整个TinyUSB协议栈适配工程的建立分为以下四个部分：</p>
<ul>
<li>device - MCU启动文件及外设驱动</li>
<li>examples - TinyUSB协议栈样例</li>
<li>tinyusb - TinyUSB协议栈源码</li>
<li>tinyusb_port - TinyUSB协议栈移植接口及USB驱动</li>
</ul>
<p><img alt="image-20240125174620782" src="../image/image-20240125174620782.png" /></p>
<center> 图x </center>

<p>除了将上述提到的 <code>MM32F5270 库函数与例程</code>软件包中的<code>device</code>文件夹和<code>TinyUSB V0.16.0</code>软件包 中<code>tinyusb\src</code> 文件夹拷贝到目标工程文件夹中外，要新建<code>examples</code>文件夹和<code>tinyusb_port</code>文件夹。在获取的TinyUSB协议栈的 examples 文件夹中，找到目标样例。接下来本文将以 <code>tinyusb\exmaples\device</code>文件夹中的<code>cdc_msc</code>样例为例进行移植演示。</p>
<h2 id="_3">配置移植接口<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<p>TinyUSB 协议栈的移植接口分为 USB Device接口和 USB Host接口，这里统一在目标工程文件夹的<code>tinyusb_port</code>文件夹中进行实现，如图x所示。</p>
<p><img alt="image-20240125174709115" src="../image/image-20240125174709115.png" /></p>
<center> 图x </center>

<p>其中<code>bsp</code>文件夹中，放置了TinyUSB协议栈中<code>tinyusb\hw\bsp</code>文件夹下的<code>ansi_escape.h</code>、<code>board.c</code> 、<code>board_api.h</code> 和<code>board_mcu.h</code> 文件，如图x所示。</p>
<p><img alt="image-20240125174750447" src="../image/image-20240125174750447.png" /></p>
<center> 图x </center>

<p><code>hal_usb.c</code>、<code>hal_usb.h</code> 、<code>hal_usb_bdt.h</code>和<code>reg_usb.h</code>文件为 USB驱动相关文件，若MCU中的 USB IP一致则可复用该USB 驱动文件。</p>
<p><code>tud_dcd_port.c</code> 和 <code>tuh_hcd_port.c</code>是基于 USB 驱动实现的TinyUSB协议栈中USB Device移植接口和USB Host移植接口 。</p>
<p><code>mini_f5277_ob.c</code>文件实现了板载MCU的USB相关的时钟配置、UART初始化、printf 函数重映射和板载LED和按键的GPIO初始化，此文件可以根据不同的开发版和MCU型号进行实现。</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;bsp/board_api.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mm32_device.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mm32f5270.h&quot;</span>

<span class="c1">// Initialize on-board peripherals : led, button, uart and USB</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">board_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="c1">// Config PLL2 clock param.</span>
<span class="w">  </span><span class="n">RCC_PLL2Config</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// PLL2 = HSE * (7+1) / (1+1) = 48MHz</span>
<span class="w">  </span><span class="n">RCC</span><span class="o">-&gt;</span><span class="n">PLL2CFGR</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">RCC_PLL2CFGR_PLL2_ICTRL_Pos</span><span class="p">;</span><span class="w"> </span>

<span class="w">  </span><span class="c1">// Enable PLL2 clock.</span>
<span class="w">  </span><span class="n">RCC_PLL2Cmd</span><span class="p">(</span><span class="n">ENABLE</span><span class="p">);</span>
<span class="w">  </span><span class="k">while</span><span class="p">((</span><span class="n">RCC</span><span class="o">-&gt;</span><span class="n">CR</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">RCC_CR_PLL2RDY_Msk</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Select PLL2 as USB clock source.</span>
<span class="w">  </span><span class="n">MODIFY_REG</span><span class="p">(</span><span class="n">RCC</span><span class="o">-&gt;</span><span class="n">CFGR</span><span class="p">,</span><span class="w"> </span><span class="n">RCC_CFGR_USBCLKSEL_Msk</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">RCC_CFGR_USBCLKSEL_Pos</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Enable USB Clock.</span>
<span class="w">  </span><span class="n">MODIFY_REG</span><span class="p">(</span><span class="n">RCC</span><span class="o">-&gt;</span><span class="n">CFGR</span><span class="p">,</span><span class="w"> </span><span class="n">RCC_CFGR_USBPRE_Msk</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">RCC_CFGR_USBPRE_Pos</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Select HSE as system clock.</span>
<span class="w">  </span><span class="n">RCC_SYSCLKConfig</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// clock init.</span>
<span class="w">  </span><span class="n">RCC_AHBPeriphClockCmd</span><span class="p">(</span><span class="n">RCC_AHBPeriph_GPIOA</span><span class="p">,</span><span class="w"> </span><span class="n">ENABLE</span><span class="p">);</span>
<span class="w">  </span><span class="n">RCC_AHBPeriphClockCmd</span><span class="p">(</span><span class="n">RCC_AHBPeriph_GPIOB</span><span class="p">,</span><span class="w"> </span><span class="n">ENABLE</span><span class="p">);</span>
<span class="w">  </span><span class="n">RCC_AHBPeriphClockCmd</span><span class="p">(</span><span class="n">RCC_AHBPeriph_GPIOC</span><span class="p">,</span><span class="w"> </span><span class="n">ENABLE</span><span class="p">);</span>
<span class="w">  </span><span class="n">RCC_APB1PeriphClockCmd</span><span class="p">(</span><span class="n">RCC_APB1Periph_UART2</span><span class="p">,</span><span class="w"> </span><span class="n">ENABLE</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// sys time init;</span>
<span class="w">  </span><span class="cp">#if CFG_TUSB_OS == OPT_OS_NONE</span>
<span class="w">    </span><span class="n">RCC_ClocksTypeDef</span><span class="w"> </span><span class="n">sys_clk</span><span class="p">;</span>
<span class="w">    </span><span class="n">RCC_GetClocksFreq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sys_clk</span><span class="p">);</span>
<span class="w">    </span><span class="n">SysTick_Config</span><span class="p">(</span><span class="n">sys_clk</span><span class="p">.</span><span class="n">SYSCLK_Frequency</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1000</span><span class="p">);</span>
<span class="w">    </span><span class="n">NVIC_SetPriority</span><span class="p">(</span><span class="n">SysTick_IRQn</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">  </span><span class="cp">#endif</span>

<span class="w">  </span><span class="c1">// peripheral init;</span>
<span class="w">  </span><span class="n">GPIO_InitTypeDef</span><span class="w"> </span><span class="n">gpio_init</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// led PB15-LED1,PB14-LED2</span>
<span class="w">  </span><span class="n">gpio_init</span><span class="p">.</span><span class="n">GPIO_Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_Mode_Out_PP</span><span class="p">;</span>
<span class="w">  </span><span class="n">gpio_init</span><span class="p">.</span><span class="n">GPIO_Speed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_Speed_High</span><span class="p">;</span>
<span class="w">  </span><span class="n">gpio_init</span><span class="p">.</span><span class="n">GPIO_Pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_Pin_15</span><span class="p">;</span>
<span class="w">  </span><span class="n">GPIO_Init</span><span class="p">(</span><span class="n">GPIOB</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">gpio_init</span><span class="p">);</span>
<span class="w">  </span><span class="n">gpio_init</span><span class="p">.</span><span class="n">GPIO_Pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_Pin_14</span><span class="p">;</span>
<span class="w">  </span><span class="n">GPIO_Init</span><span class="p">(</span><span class="n">GPIOB</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">gpio_init</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// btn PB0-K1,PB1-K2</span>
<span class="w">  </span><span class="n">gpio_init</span><span class="p">.</span><span class="n">GPIO_Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_Mode_IPU</span><span class="p">;</span>
<span class="w">  </span><span class="n">gpio_init</span><span class="p">.</span><span class="n">GPIO_Pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_Pin_0</span><span class="p">;</span>
<span class="w">  </span><span class="n">GPIO_Init</span><span class="p">(</span><span class="n">GPIOB</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">gpio_init</span><span class="p">);</span>
<span class="w">  </span><span class="n">gpio_init</span><span class="p">.</span><span class="n">GPIO_Pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_Pin_1</span><span class="p">;</span>
<span class="w">  </span><span class="n">GPIO_Init</span><span class="p">(</span><span class="n">GPIOB</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">gpio_init</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// uart PA2-TX,PA3-RX</span>
<span class="w">  </span><span class="n">gpio_init</span><span class="p">.</span><span class="n">GPIO_Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_Mode_AF_PP</span><span class="p">;</span>
<span class="w">  </span><span class="n">gpio_init</span><span class="p">.</span><span class="n">GPIO_Pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_Pin_2</span><span class="p">;</span>
<span class="w">  </span><span class="n">GPIO_PinAFConfig</span><span class="p">(</span><span class="n">GPIOA</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_PinSource2</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_AF_7</span><span class="p">);</span>
<span class="w">  </span><span class="n">GPIO_Init</span><span class="p">(</span><span class="n">GPIOA</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">gpio_init</span><span class="p">);</span>

<span class="w">  </span><span class="n">gpio_init</span><span class="p">.</span><span class="n">GPIO_Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_Mode_IPU</span><span class="p">;</span>
<span class="w">  </span><span class="n">gpio_init</span><span class="p">.</span><span class="n">GPIO_Pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_Pin_3</span><span class="p">;</span>
<span class="w">  </span><span class="n">GPIO_PinAFConfig</span><span class="p">(</span><span class="n">GPIOA</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_PinSource3</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_AF_7</span><span class="p">);</span>
<span class="w">  </span><span class="n">GPIO_Init</span><span class="p">(</span><span class="n">GPIOA</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">gpio_init</span><span class="p">);</span>

<span class="w">  </span><span class="n">UART_InitTypeDef</span><span class="w"> </span><span class="n">UART_InitStruct</span><span class="p">;</span>
<span class="w">  </span><span class="n">UART_StructInit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">UART_InitStruct</span><span class="p">);</span>
<span class="w">  </span><span class="n">UART_InitStruct</span><span class="p">.</span><span class="n">BaudRate</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">CFG_BOARD_UART_BAUDRATE</span><span class="p">;</span>
<span class="w">  </span><span class="n">UART_InitStruct</span><span class="p">.</span><span class="n">WordLength</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">UART_WordLength_8b</span><span class="p">;</span>
<span class="w">  </span><span class="n">UART_InitStruct</span><span class="p">.</span><span class="n">StopBits</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">UART_StopBits_1</span><span class="p">;</span>
<span class="w">  </span><span class="n">UART_InitStruct</span><span class="p">.</span><span class="n">Parity</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">UART_Parity_No</span><span class="p">;</span>
<span class="w">  </span><span class="n">UART_InitStruct</span><span class="p">.</span><span class="n">HWFlowControl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UART_HWFlowControl_None</span><span class="p">;</span>
<span class="w">  </span><span class="n">UART_InitStruct</span><span class="p">.</span><span class="n">Mode</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">UART_Mode_Tx</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">UART_Mode_Rx</span><span class="p">;</span>
<span class="w">  </span><span class="n">UART_Init</span><span class="p">(</span><span class="n">UART2</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">UART_InitStruct</span><span class="p">);</span>

<span class="w">  </span><span class="n">UART_Cmd</span><span class="p">(</span><span class="n">UART2</span><span class="p">,</span><span class="w"> </span><span class="n">ENABLE</span><span class="p">);</span>

<span class="w">  </span><span class="n">RCC_AHBPeriphClockCmd</span><span class="p">(</span><span class="n">RCC_AHBPeriph_USB_FS</span><span class="p">,</span><span class="w"> </span><span class="n">ENABLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Turn LED on or off</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">board_led_write</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n">GPIOB</span><span class="o">-&gt;</span><span class="n">BRR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">14</span><span class="p">;</span>
<span class="w">    </span><span class="n">GPIOB</span><span class="o">-&gt;</span><span class="n">BRR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">15</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n">GPIOB</span><span class="o">-&gt;</span><span class="n">BSRR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">14</span><span class="p">;</span>
<span class="w">    </span><span class="n">GPIOB</span><span class="o">-&gt;</span><span class="n">BSRR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">15</span><span class="p">;</span>
<span class="w">  </span><span class="p">};</span>
<span class="p">}</span>

<span class="c1">// Control led pattern using phase duration in ms.</span>
<span class="c1">// For each phase, LED is toggle then repeated, board_led_task() is required to be called</span>
<span class="c1">//void board_led_pattern(uint32_t const phase_ms[], uint8_t count);</span>

<span class="c1">// Get the current state of button</span>
<span class="c1">// a &#39;1&#39; means active (pressed), a &#39;0&#39; means inactive.</span>
<span class="kt">uint32_t</span><span class="w"> </span><span class="nf">board_button_read</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">GPIOB</span><span class="o">-&gt;</span><span class="n">IDR</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="n">GPIOB</span><span class="o">-&gt;</span><span class="n">IDR</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Get characters from UART. Return number of read bytes</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">board_uart_read</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">UART2</span><span class="o">-&gt;</span><span class="n">CSR</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">UART_CSR_RXAVL_Msk</span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UART2</span><span class="o">-&gt;</span><span class="n">RDR</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Send characters to UART. Return number of sent bytes</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">board_uart_write</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">len</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n">putchar</span><span class="p">(((</span><span class="kt">char</span><span class="o">*</span><span class="p">)(</span><span class="n">buf</span><span class="p">))[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if CFG_TUSB_OS == OPT_OS_NONE</span>
<span class="k">volatile</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">systime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="c1">// Get current milliseconds, must be implemented when no RTOS is used</span>
<span class="kt">uint32_t</span><span class="w"> </span><span class="nf">board_millis</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">systime</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">SysTick_Handler</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">systime</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="c1">// stdio getchar() is blocking, this is non-blocking version</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">board_getchar</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">UART2</span><span class="o">-&gt;</span><span class="n">CSR</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">UART_CSR_RXAVL_Msk</span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">UART2</span><span class="o">-&gt;</span><span class="n">RDR</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">fputc</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">ch</span><span class="p">,</span><span class="w"> </span><span class="kt">FILE</span><span class="w"> </span><span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">UART2</span><span class="o">-&gt;</span><span class="n">TDR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ch</span><span class="p">;</span>

<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">UART2</span><span class="o">-&gt;</span><span class="n">CSR</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">UART_CSR_TXFULL_Msk</span><span class="p">)</span>
<span class="w">  </span><span class="p">{}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">fgetc</span><span class="p">(</span><span class="kt">FILE</span><span class="o">*</span><span class="w"> </span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">ch</span><span class="p">;</span>

<span class="w">  </span><span class="k">while</span><span class="p">((</span><span class="n">ch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">board_getchar</span><span class="p">())</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">  </span><span class="p">{}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">ch</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>需要注意的是提供过给 USB 模块的这个 48MHz 时钟可以来自于PLL1 的 N 分频，PLL2 的 N 分频，部分 MCU 可能还有其他的选择。这个 48MHz 时钟需要尽可能精确，如有必要，向 MCU 提供时钟的外部晶振都可以换成 <code>12.000MHz</code> （注意小数点后面有3个0）的晶振，以保证 48MHz 足够精确。</p>
<h3 id="usb-device">配置USB Device接口<a class="headerlink" href="#usb-device" title="Permanent link">&para;</a></h3>
<p>USB Device移植接口在<code>tud_dcd_port.c</code>文件中实现，主要分为如下部分：</p>
<ul>
<li>SETUP 包的接收</li>
<li>设置地址</li>
<li>接口适配</li>
<li>中断处理</li>
</ul>
<p>定义全局变量</p>
<p>为了适配 TinyUSB Device，在适配层一共设置如下全局变量：</p>
<div class="highlight"><pre><span></span><code>/* OTG_FS BufferDescriptorTable Buffer. */
static __ALIGNED(512u) USB_BufDespTable_Type usb_bd_tbl = {0u}; /*usb_bufdesp_table */
static uint8_t usb_ep0_buf[CFG_TUD_ENDPOINT0_SIZE] = {0u}; /*usb_recv_buff. */
static uint8_t usb_setup_buf[8u] = {0u}; /* usb_setup_buff. */
static uint8_t usb_device_addr = 0u; /* usb_device_addr. */
typedef struct
{
    uint8_t * xfer_buf;
    uint32_t max_packet_size; /* EndPoint max packet size. */
    uint32_t length; /* EndPoint xfer data length. */
    uint32_t remaining; /* EndPoint xfer data remaining. */
    bool odd_even; /* EndPoint BD OddEven status. */
    bool data_n; /* next packet is DATA0 or DATA1. */
    bool xfer_done;
} USB_EndPointManage_Type;
static USB_EndPointManage_Type usb_epmng_tbl[16u][2u] = {0u}; /* EndPointManage Table. */
</code></pre></div>
<p>在<code>tud_dcd_port.c</code> 文件中定义USB 数据缓冲区（在USB驱动中定义USB_BufDespTable_Type结构体类型），并在USB驱动初始化和USB协议栈任务处理时使用。</p>
<div class="highlight"><pre><span></span><code>static __ALIGNED(512u) USB_BufDespTable_Type usb_bd_tbl = {0u}; /* usb_bufdesp_table */
</code></pre></div>
<h4 id="usb">USB 端点管理<a class="headerlink" href="#usb" title="Permanent link">&para;</a></h4>
<p>在<code>tud_dcd_port.c</code>文件中定义<code>USB_EndPointManage_Type</code>结构体类型。</p>
<div class="highlight"><pre><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">xfer_buf</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">max_packet_size</span><span class="p">;</span><span class="w">   </span><span class="cm">/* EndPoint max packet size. */</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">length</span><span class="p">;</span><span class="w">            </span><span class="cm">/* EndPoint xfer data length. */</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">remaining</span><span class="p">;</span><span class="w">         </span><span class="cm">/* EndPoint xfer data remaining. */</span>
<span class="w">    </span><span class="kt">bool</span><span class="w">  </span><span class="n">odd_even</span><span class="p">;</span><span class="w">          </span><span class="cm">/* EndPoint BD OddEven status. */</span>
<span class="w">    </span><span class="kt">bool</span><span class="w">  </span><span class="n">data_n</span><span class="p">;</span><span class="w">            </span><span class="cm">/* next packet is DATA0 or DATA1. */</span>
<span class="w">    </span><span class="kt">bool</span><span class="w">  </span><span class="n">xfer_done</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">USB_EndPointManage_Type</span><span class="p">;</span>
</code></pre></div>
<h4 id="usb_1">USB 驱动使能<a class="headerlink" href="#usb_1" title="Permanent link">&para;</a></h4>
<p>在<code>tud_dcd_port.c</code>中的<code>dcd_init()</code>函数实现。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Initialize controller to device mode</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">dcd_init</span><span class="w">       </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">rhport</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">rhport</span><span class="p">;</span>
<span class="w">    </span><span class="n">USB_Device_Init_Type</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0u</span><span class="p">};</span>
<span class="w">    </span><span class="n">init</span><span class="p">.</span><span class="n">BufDespTable_Addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">usb_bd_tbl</span><span class="p">;</span>
<span class="w">    </span><span class="n">USB_InitDevice</span><span class="p">(</span><span class="n">BOARD_USB_PORT</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">init</span><span class="p">);</span>
<span class="w">    </span><span class="n">USB_Enable</span><span class="p">(</span><span class="n">BOARD_USB_PORT</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="w">    </span><span class="n">NVIC_ClearPendingIRQ</span><span class="p">(</span><span class="n">BOARD_USB_IRQn</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="usb-device_1">USB Device 中断<a class="headerlink" href="#usb-device_1" title="Permanent link">&para;</a></h4>
<p>在<code>tud_dcd_port.c</code>中的<code>dcd_int_enable()</code>和<code>dcd_int_disable()</code>函数实现 USB Device设备的中断开启与关闭。</p>
<div class="highlight"><pre><span></span><code>// Enable device interrupt
void dcd_int_enable (uint8_t rhport)
{
    (void) rhport;
    USB_EnableInterrupts(BOARD_USB_PORT, USB_INT_RESET | USB_INT_TOKENDONE
                                            | USB_INT_SLEEP
                                            | USB_INT_RESUME
                                            | USB_INT_STALL
                                            | USB_INT_SOFTOK, true); /* enable interrupts*/
    NVIC_SetPriority(BOARD_USB_IRQn, 3u);
    NVIC_EnableIRQ(BOARD_USB_IRQn);
}
</code></pre></div>
<p>并在<code>tud_dcd_port.c</code>中的<code>dcd_int_handler()</code>函数实现 USB Device 设备的中断服务函数。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Interrupt Handler</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">dcd_int_handler</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">rhport</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">USB_GetInterruptStatus</span><span class="p">(</span><span class="n">BOARD_USB_PORT</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">flag</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">USB_INT_TOKENDONE</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">USB_TokenDoneHandler</span><span class="p">(</span><span class="n">rhport</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">flag</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">USB_INT_RESET</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">USB_ClearInterruptStatus</span><span class="p">(</span><span class="n">BOARD_USB_PORT</span><span class="p">,</span><span class="w"> </span><span class="n">USB_INT_RESET</span><span class="p">);</span>
<span class="w">        </span><span class="n">USB_BusResetHandler</span><span class="p">();</span>

<span class="w">        </span><span class="n">dcd_event_bus_reset</span><span class="p">(</span><span class="n">rhport</span><span class="p">,</span><span class="w"> </span><span class="n">TUSB_SPEED_FULL</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">flag</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">USB_INT_SLEEP</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">USB_ClearInterruptStatus</span><span class="p">(</span><span class="n">BOARD_USB_PORT</span><span class="p">,</span><span class="w"> </span><span class="n">USB_INT_SLEEP</span><span class="p">);</span>

<span class="w">        </span><span class="n">dcd_event_bus_signal</span><span class="p">(</span><span class="n">rhport</span><span class="p">,</span><span class="w"> </span><span class="n">DCD_EVENT_SUSPEND</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">flag</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">USB_INT_RESUME</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">USB_ClearInterruptStatus</span><span class="p">(</span><span class="n">BOARD_USB_PORT</span><span class="p">,</span><span class="w"> </span><span class="n">USB_INT_RESUME</span><span class="p">);</span>

<span class="w">        </span><span class="n">dcd_event_bus_signal</span><span class="p">(</span><span class="n">rhport</span><span class="p">,</span><span class="w"> </span><span class="n">DCD_EVENT_RESUME</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">flag</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">USB_INT_STALL</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">USB_EnableEndPointStall</span><span class="p">(</span><span class="n">BOARD_USB_PORT</span><span class="p">,</span><span class="w"> </span><span class="n">USB_EP_0</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<span class="w">        </span><span class="n">dcd_edpt_clear_stall</span><span class="p">(</span><span class="n">rhport</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">        </span><span class="n">USB_BufDesp_Xfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usb_bd_tbl</span><span class="p">.</span><span class="n">Table</span><span class="p">[</span><span class="mi">0u</span><span class="p">][</span><span class="n">USB_Direction_OUT</span><span class="p">][</span><span class="n">usb_epmng_tbl</span><span class="p">[</span><span class="mi">0u</span><span class="p">][</span><span class="n">USB_Direction_OUT</span><span class="p">].</span><span class="n">odd_even</span><span class="p">],</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">usb_ep0_buffer</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">);</span>
<span class="w">        </span><span class="n">USB_ClearInterruptStatus</span><span class="p">(</span><span class="n">BOARD_USB_PORT</span><span class="p">,</span><span class="w"> </span><span class="n">USB_INT_STALL</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">flag</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">USB_INT_SOFTOK</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">USB_ClearInterruptStatus</span><span class="p">(</span><span class="n">BOARD_USB_PORT</span><span class="p">,</span><span class="w"> </span><span class="n">USB_INT_SOFTOK</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* USB IRQ. */</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">BOARD_USB_IRQHandler</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">dcd_int_handler</span><span class="p">(</span><span class="n">BOARD_TUD_RHPORT</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="usb-host">配置USB Host接口<a class="headerlink" href="#usb-host" title="Permanent link">&para;</a></h3>
<p>MM32G5330 USB 支持 Host 功能，TinyUSB 协议栈中也包含了 Host 部分，在适配 Host 过程中，使用到了双向队列和数据库的概念。USB Host移植接口在<code>tuh_dcd_port.c</code>文件中实现，主要分为如下步骤：</p>
<ul>
<li>双向队列实现</li>
<li>数据库实现</li>
<li>接口实现</li>
<li>中断处理</li>
</ul>
<h4 id="_4">双向队列实现<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h4>
<p>USB 总线会像多个端点传输不同的内容，但 USB 总线只有一条，因此需要将传输任务放在一个队列中，按照队列的顺序传输数据 ；在传输过程中，可能会有分段传输，传输失败等情况，可能要将传输任务重新放在队列的头部，而不是末尾，因此，这个队列不仅能将传输任务放在队列尾部，也能将传输任务放在头部，就像堆栈那样，因此，需要实现一个双向队列。同普通的队列一样，双向队列需要一个队列buffer，以及管理队列 buffer 的字段，然后每次读写队列时，不能直接操作这个 buffer，而是只能使用给定的 push 和 pop 方法操作。实现操作如下：</p>
<p><strong>buffer 和管理字段：</strong></p>
<div class="highlight"><pre><span></span><code><span class="cm">/* xfer task deque node. */</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span>
<span class="p">{</span>
<span class="p">......</span>
<span class="p">}</span><span class="w"> </span><span class="n">xfer_task_node_t</span><span class="p">;</span>

<span class="cm">/* xfer task deque support. */</span>
<span class="k">static</span><span class="w"> </span><span class="n">xfer_task_node_t</span><span class="w"> </span><span class="n">xfer_task_deque</span><span class="p">[</span><span class="n">TUH_HCD_PORT_XFER_TASK_DEQUE_SIZE</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="p">{</span><span class="mi">0u</span><span class="p">};</span><span class="w"> </span><span class="cm">/* xfer task deque buf. */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">xfer_task_head</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0u</span><span class="p">;</span><span class="w"> </span><span class="cm">/* record deque head. */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">xfer_task_tail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0u</span><span class="p">;</span><span class="w"> </span><span class="cm">/* record deque tail. */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">xfer_task_cnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0u</span><span class="p">;</span><span class="w"> </span><span class="cm">/* record xfer task num. */</span>
</code></pre></div>
<p><strong>操作函数：</strong></p>
<p>从头部 pop，从尾部 push：</p>
<div class="highlight"><pre><span></span><code><span class="cm">/* get deque head node &amp; delete the node in deque. */</span>
<span class="kt">bool</span><span class="w"> </span><span class="nf">xfer_task_pop_head</span><span class="p">(</span><span class="n">xfer_task_node_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">0u</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">xfer_task_cnt</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"> </span><span class="cm">/* no xfer_task. */</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/* pop head: read head, head--, cnt--. */</span>
<span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="n">task</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">xfer_task_deque</span><span class="p">[</span><span class="n">xfer_task_head</span><span class="p">],</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">xfer_task_node_t</span><span class="p">));</span><span class="w"> </span><span class="cm">/* read head. */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">xfer_task_head</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0u</span><span class="p">)</span><span class="w"> </span><span class="cm">/* head--. */</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">xfer_task_head</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TUH_HCD_PORT_XFER_TASK_DEQUE_SIZE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1u</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">xfer_task_head</span><span class="o">--</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">xfer_task_cnt</span><span class="o">--</span><span class="p">;</span><span class="w"> </span><span class="cm">/* cnt--. */</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* put node in deque tail. */</span>
<span class="kt">bool</span><span class="w"> </span><span class="nf">xfer_task_push_tail</span><span class="p">(</span><span class="n">xfer_task_node_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">TUH_HCD_PORT_XFER_TASK_DEQUE_SIZE</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">xfer_task_cnt</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"> </span><span class="cm">/* queue full. */</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/* push tail: write tail, tail--, cnt++ */</span>

<span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xfer_task_deque</span><span class="p">[</span><span class="n">xfer_task_tail</span><span class="p">],</span><span class="w"> </span><span class="n">task</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">xfer_task_node_t</span><span class="p">));</span><span class="w"> </span><span class="cm">/* write tail. */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">xfer_task_tail</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0u</span><span class="p">)</span><span class="w"> </span><span class="cm">/* head++. */</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">xfer_task_tail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TUH_HCD_PORT_XFER_TASK_DEQUE_SIZE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1u</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">xfer_task_tail</span><span class="o">--</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">xfer_task_cnt</span><span class="o">++</span><span class="p">;</span><span class="cm">/* cnt++. */</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>有了上面的两个方法，这就是一个普通的单项队列，英文叫做 queue，既然是双向队列，就需要在这个基础上实现从头部 push 的功能，至于尾部 pop 由于在适配过程中没有使用，不再实现，下述为相关代码实现：</p>
<div class="highlight"><pre><span></span><code><span class="cm">/* put node in deque head. */</span>
<span class="kt">bool</span><span class="w"> </span><span class="nf">xfer_task_push_head</span><span class="p">(</span><span class="n">xfer_task_node_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">TUH_HCD_PORT_XFER_TASK_DEQUE_SIZE</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">xfer_task_cnt</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"> </span><span class="cm">/* queue full. */</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/* push head: head++, write head, cnt++ */</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">xfer_task_head</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">TUH_HCD_PORT_XFER_TASK_DEQUE_SIZE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1u</span><span class="p">)</span><span class="w"> </span><span class="cm">/* head++. */</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">xfer_task_head</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0u</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">xfer_task_head</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xfer_task_deque</span><span class="p">[</span><span class="n">xfer_task_head</span><span class="p">],</span><span class="w"> </span><span class="n">task</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">xfer_task_node_t</span><span class="p">));</span><span class="w"> </span><span class="cm">/* write tail. */</span>
<span class="w">    </span><span class="n">xfer_task_cnt</span><span class="o">++</span><span class="p">;</span><span class="cm">/* cnt++. */</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>需要清空双向队列的内容时，或初始化双向队列时，可使用下列方法操作:</p>
<div class="highlight"><pre><span></span><code><span class="cm">/* reset the deque, delete all node. */</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">xfer_task_reset</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">xfer_task_head</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0u</span><span class="p">;</span>
<span class="w">    </span><span class="n">xfer_task_tail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0u</span><span class="p">;</span>
<span class="w">    </span><span class="n">xfer_task_cnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0u</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="_5">数据库实现<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h4>
<p>所谓数据库，只是用于存放各设备各端点信息的地方。每次发送传输数据的时候，需要知道端点的buffer 大小等信息，所以需要在数据库中查询端点信息。需要支持inset操作，delete操作，update 操作和select操作，即增删改查：</p>
<p>insert 操作，指将一条数据条目插入到数据表中，该条目是数据表中原来没有的内容</p>
<p>delete 操作，指删除数据条目或数据表</p>
<p>update 操作，指将一条数据条目更新到原有的条目中，主要更新原有条目的字段内容</p>
<p>select 操作，根据关键字查找数据表中的条目</p>
<p><strong>buffer 和管理字段：</strong></p>
<div class="highlight"><pre><span></span><code><span class="cm">/* endpoint status table. */</span>
<span class="k">static</span><span class="w"> </span><span class="n">ep_status_t</span><span class="w"> </span><span class="n">ep_tbl</span><span class="p">[</span><span class="n">TUH_HCD_PORT_MAX_EP_NUM</span><span class="p">];</span><span class="w"> </span><span class="cm">/* the table that record the ep_status. */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">ep_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0u</span><span class="p">;</span><span class="w"> </span><span class="cm">/* record the how many endpoint status in ep_tbl[]. */</span>
</code></pre></div>
<p><strong>insert &amp; update 操作：</strong></p>
<div class="highlight"><pre><span></span><code><span class="cm">/* add new or modify endpoint status. */</span>
<span class="kt">bool</span><span class="w"> </span><span class="nf">ep_set_status</span><span class="p">(</span><span class="n">ep_status_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">ep_status_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ep_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ep_get_status</span><span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">dev_ep_addr</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">NULL</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ep_status</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ep_count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">TUH_HCD_PORT_MAX_EP_NUM</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">ep_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ep_tbl</span><span class="p">[</span><span class="n">ep_count</span><span class="p">];</span>
<span class="w">        </span><span class="n">ep_count</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="n">ep_status</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">ep_status_t</span><span class="p">));</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>select 操作：</strong></p>
<div class="highlight"><pre><span></span><code><span class="cm">/* get endpoint status. */</span>
<span class="n">ep_status_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">ep_get_status</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">dev_ep_addr</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">ep_status_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ep_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0u</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ep_count</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">dev_ep_addr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ep_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev_ep_addr</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">ep_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ep_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ep_status</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>除了上面的操作，当 USB Device 拔掉的时候，数据库需要进行复位，相当于执行 delete 操作：</p>
<div class="highlight"><pre><span></span><code><span class="cm">/* clear all endpoint status. */</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">ep_reset</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">ep_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0u</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="usb_2">USB 缓冲描述表定义<a class="headerlink" href="#usb_2" title="Permanent link">&para;</a></h4>
<p>在<code>tuh_dcd_port.c</code> 文件中定义USB 数据缓冲区（在USB驱动中定义USB_BufDespTable_Type结构体类型），在USB驱动初始化和USB协议栈任务处理时使用。
USB的配置由两部分组成：一部分是实实在在的 USB 寄存器配置，一部分是 SRAM 以 512 字节对齐的 512 字节大小的缓冲区描述表。</p>
<p>那么如何得到一块 512 Bytes 对齐的内存？这里举出三种方法：</p>
<blockquote>
<ol>
<li>在 linker 中声明出一段 512 字节对齐的 512 字节大小的空间。</li>
<li>使用 "__ALIGNED(512)" 或 "__attribute__((__aligned__(512)))" 等指令让编译器处理。</li>
<li>声明一段 1K 大小的空间，然后在其中找到 512 字节对齐的位置。</li>
</ol>
</blockquote>
<p>这里我们采用了第2种方法进行了实现：</p>
<div class="highlight"><pre><span></span><code>/* usb buf descriptor table. */
__attribute__ ((aligned(512))) static USB_BufDespTable_Type usb_bdt = {0u};

/* speed status. */
volatile static tusb_speed_t device_speed = TUSB_SPEED_FULL;

/* xfer_buf. */
__attribute__ ((aligned(4))) static uint8_t usb_xfer_buf[TUH_HCD_PORT_XFER_BUF_SIZE] = {0u};
</code></pre></div>
<p>在初始化 USB 的时候，需要将缓冲区描述表的起始地址写入到 USB 寄存器中（USB_FS_BDTPAGE1，USB_FS_BDTPAGE2，USB_FS_BDTPAGE3），随后，这块缓冲区描述表就 “成为” 了 USB 寄存器中的一部分，当我们想要传输数据的时候，就会把要传输数据的缓冲区地址，缓冲区大小等信息写入到这个缓冲区描述表中，待传输数据完成后，缓冲区描述表中记录的内容也会发生变化，对这块缓冲区描述表的操作，就如同在 USB 寄存器上进行操作一般。</p>
<p>USB 数据的传输实际上是依靠 DMA 搬运实现的，但值得注意的是，USB 使用的 DMA 并不是 MCU 中的 DMA 外设，而是 USB 自带的 DMA，并且除了使用 USB 自带的 DMA 搬运的方式传输数据外，USB 并没有提供其他传输数据的方法。由于采用 DMA 搬运的方法传输数据，在使用 USB 功能的时候，需要注意一些会影响 DMA 工作的地方：例如，打开 DCACHE 后，对 SRAM 的访问并非直接写入到 SRAM 中，而是先暂时放入到内核的 CACHE 中，会造成 DMA 无法正常工作，所以，在使用 USB 功能的时候，应关闭 DCACHE 功能（或者使用 MPU 对 USB 使用到的内存加以保护）；再例如，有些 RAM 仅能被 CPU 访问，如 DTCM，这部分空间无法让 DMA 正常工作，因此也要避免将缓冲区描述表和要传输的数据存放在此类区域。</p>
<p>缓冲区描述表控制着十六个端点的传输功能，每个端点有两个传输方向，分别是 IN 和 OUT（如果每个传输方向算一个端点的话，USB_0 一共有 32 个端点）每个传输方向有两个缓冲区描述符组成，在传输数据的时候，两个缓冲区描述符交替工作，从而实现乒乓操作的过程，加快数据传输的速度。当然，双缓冲的操作较为复杂，增加了 USB 的操作难度，双缓冲也可配置为单缓冲，简化使用方法。</p>
<p><img alt="" src="../image/figure_usb_bd.png" /></p>
<center> 图x 缓冲区描述符
如图x所示，每个缓冲区描述符由两个四字节数据组成，第一个四字节数据记录了要传输数据的大小，data toggle，缓冲区描述符的拥有者等字段信息，第二个四字节数据则记录了要传输数据的起始位置。具体的字段信息，可参考各 MCU 的 UM。

#### USB 端点管理

在`tud_dcd_port.c`文件中定义`USB_EndPointManage_Type`结构体类型。

<div class="highlight"><pre><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">xfer_buf</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">max_packet_size</span><span class="p">;</span><span class="w">   </span><span class="cm">/* EndPoint max packet size. */</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">length</span><span class="p">;</span><span class="w">            </span><span class="cm">/* EndPoint xfer data length. */</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">remaining</span><span class="p">;</span><span class="w">         </span><span class="cm">/* EndPoint xfer data remaining. */</span>
<span class="w">    </span><span class="kt">bool</span><span class="w">  </span><span class="n">odd_even</span><span class="p">;</span><span class="w">          </span><span class="cm">/* EndPoint BD OddEven status. */</span>
<span class="w">    </span><span class="kt">bool</span><span class="w">  </span><span class="n">data_n</span><span class="p">;</span><span class="w">            </span><span class="cm">/* next packet is DATA0 or DATA1. */</span>
<span class="w">    </span><span class="kt">bool</span><span class="w">  </span><span class="n">xfer_done</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">USB_EndPointManage_Type</span><span class="p">;</span>
</code></pre></div>

#### USB驱动使能

在`tuh_dcd_port.c`中的`dcd_init()`函数实现。

<div class="highlight"><pre><span></span><code><span class="cm">/* Initialize controller to host mode. */</span>
<span class="kt">bool</span><span class="w"> </span><span class="nf">hcd_init</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">rhport</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">rhport</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* init usb host module. */</span>
<span class="w">    </span><span class="n">USB_Host_Init_Type</span><span class="w"> </span><span class="n">usb_init</span><span class="p">;</span>
<span class="w">    </span><span class="n">usb_init</span><span class="p">.</span><span class="n">BufDespTable_Addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">usb_bdt</span><span class="p">);</span>
<span class="w">    </span><span class="n">usb_init</span><span class="p">.</span><span class="n">SofThreshold</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">BOARD_USB_SOFTHRESHOLD</span><span class="p">;</span>
<span class="w">    </span><span class="n">usb_init</span><span class="p">.</span><span class="n">NakRetry</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="n">USB_InitHost</span><span class="p">(</span><span class="n">BOARD_USB_PORT</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">usb_init</span><span class="p">);</span>

<span class="w">    </span><span class="n">USB_EnableOddEvenReset</span><span class="p">(</span><span class="n">BOARD_USB_PORT</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span><span class="w"> </span><span class="cm">/* only use even buf desp, this example will not usb odd buf desp xfer data. */</span>
<span class="w">    </span><span class="n">USB_SetDeviceAddr</span><span class="p">(</span><span class="n">BOARD_USB_PORT</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">);</span><span class="w"> </span><span class="cm">/* set usb addr is 0x00, to xfer data when device attached. */</span>

<span class="w">    </span><span class="cm">/* enable interrupt, but not use NVIC_EnableIRQ(). */</span>
<span class="w">    </span><span class="n">NVIC_ClearPendingIRQ</span><span class="p">(</span><span class="n">BOARD_USB_IRQn</span><span class="p">);</span>
<span class="w">    </span><span class="n">USB_EnableInterrupts</span><span class="p">(</span><span class="n">BOARD_USB_PORT</span><span class="p">,</span><span class="w"> </span><span class="n">USB_INT_ATTACH</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">USB_INT_ERROR</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="w">    </span><span class="n">USB_EnableErrInterrupts</span><span class="p">(</span><span class="n">BOARD_USB_PORT</span><span class="p">,</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

#### USB Host中断

USB Host 中断的使能在`tuh_dcd_port.c`中的`hcd_init()`函数中已经实现。相较于 USB Device 中断的使能，USB Host 中断只开启了 `USB_INT_ATTACH`中断和`USB_INT_ERROR`中断。在`tud_dcd_port.c`中的`BOARD_USB_IRQHandler()`函数实现 USB Host 设备的中断服务函数。

<div class="highlight"><pre><span></span><code>/*
 * USB interrupt handler.
 */
void BOARD_USB_IRQHandler(void)
{
    uint32_t flag = USB_GetInterruptStatus(BOARD_USB_PORT);
    flag &amp;= USB_GetEnabledInterrupts(BOARD_USB_PORT);

    /* device attached. */
    if (0u != (flag &amp; USB_INT_ATTACH))
    {
        process_attach();
    }

    /* sof token, prepare to xfer packet. */
    if (0u != (flag &amp; USB_INT_SOFTOK))
    {
        process_softok();
    }

    /* xfer a token done. */
    if (0u != (flag &amp; USB_INT_TOKENDONE))
    {
        process_token_done();
    }

    /* device detached. */
    if (0u != (flag &amp; USB_INT_RESET))
    {
        tuh_task(); /* clear all event. */
        process_detach(); /* do detache process. */
    }

    if (0u != (flag &amp; USB_INT_ERROR))
    {
        tuh_task(); /* clear all event. */
        process_detach(); /* do detache process. */
        uint32_t err = USB_GetErrInterruptStatus(BOARD_USB_PORT);
        USB_ClearErrInterruptStatus(BOARD_USB_PORT, err); /* clear err interrut. */
    }

    USB_ClearInterruptStatus(BOARD_USB_PORT, flag);
}
</code></pre></div>

## 创建工程样例

在目标工程的`examples`文件夹下新建`tud_cdc_msc`文件夹，将`cdc_msc\src`文件夹中的样例源码`main.c`、`msc_disk.c`、`tusb_config.h` 和 `usb_descriptors.c`拷贝到目标工程中的 `examples\tud_cdc_msc`文件夹中，如图x所示；在该文件夹下根据对应工具链新建文件夹和创建对应的编译配置工程，下图x展示了以Keil MDK 工具链为例的工程模板。

![样例文件结构](./image/image-20240119140000356.png)

<center>图x 样例文件结构 </center>

![Keil MDK 工程样例](./image/image-20240119144547674.png)

<center> 图x Keil MDK 工程样例 </center>

对于工程中的全局宏的配置如下图x所示。这里需要注意的是，且我们使用到了板载的`12.000MHz`高精度外部高速晶振，需要在工程配置中定义全局宏`CUSTOM_HSE_VAL`。

![配置工程全局宏参数](./image/image-20240124172429743.png)

<center> 配置工程全局宏参数 </center>



## 样例演示

TinyUSB 协议栈自身提供了丰富的 USB Device样例和 USB Host 样例，我们只需要通过使用配置好的 USB Device接口和 USB Host 接口，和 TinyUSB 协议栈提供协议栈源文件和样例代码，按照不同的样例重新建立对应的工程便可实现 TinyUSB 提供的USB Device样例和 USB Host 样例。

- LibTinyUSB 中已实现多个 tinyusb 的样例，样例全部来自 tinyusb 官方实现的代码，但 LibTinyUSB 中的 examples 为了减小 size，删除了 examples 文件夹，可到 tinyusb 官网拉取最新的 git 仓库，获取 examples。
- 将 examples 的某一个样例中的源代码复制，替换 LibTinyUSB 样例中的 app 代码，即可实现新的 app 代码。

这里我们仍然以基于`Mini-F5277-OB`开发板的`tud_cdc_msc`样例的 Keil MDK工程为例，验证其实现效果：

在完成前述代码移植和工程配置之后，进行编译下载，这里下载器我们直接使用 `Mini-F5277-OB`开发板板载的 CMSIS-DAP 下载器，然后直接进行下载。

![image-20240125180945762](./image/image-20240125180945762.png)

固件下载完成后通过 USB 数据线将 PC 端和开发板的 `USB-MCU`接口进行连接（这里我们PC端用到的操作系统是 Win10），连接好后按下开发板的复位按键，PC端将会自动弹出 USB Device 在PC 端枚举的一个描述符为`TinyUSB MSC`的可移动磁盘设备，如下图x所示：

![image-20240125181602843](./image/image-20240125181602843.png)

<center> 图x </center>

至此，代表样例工程`tud_cdc_msc`成功运行，并在 PC 端完成了USB Device枚举大容量存储设备功能。

## TinyUSB协议栈样例介绍

### board_test

该样例为TinyUSB提供的基本板载样例，用于测试验证MCU和开发板能否正常运行，若运行正常则板载LED会进行闪烁，并在串口输出指定字符串。

### tud_cdc_dual_ports

该样例为TinyUSB提供的USB Device双串口样例，用于演示USB Device枚举双串口功能。

### tud_cdc_msc

该样例为TinyUSB提供的USB Device大容量存储设备样例，用于演示USB Device枚举大容量存储设备功能。

### tud_hid_composite

该样例为TinyUSB提供的USB Device HID样例，用于演示USB Device枚举鼠标键盘设备功能。

### tud_msc_dual_lun

该样例为TinyUSB提供的USB Device大容量存储设备样例，用于演示USB Device枚举两个大容量存储设备功能。

### tud_video_capture

该样例为TinyUSB提供的USB Device摄像头样例，用于演示USB Device枚举一个摄像头设备功能。

### tud_webusb_serial

该样例为TinyUSB提供的USB Device的Vender样例，用于演示USB Device枚举网页USB串口设备功能。

### tuh_bare_api

该样例为TinyUSB提供的USB Host的基本API使用演示样例，用于演示USB Host读取FATFS 格式的存储设备（如：U盘）功能。

### tuh_cdc_msc_hid

该样例为TinyUSB提供的USB Host读取大容量存储设演示样例，用于演示USB Host读取FATFS 格式的存储设备（如：U盘）功能。

### tuh_hid_controller

该样例为TinyUSB提供的USB Host控制器样例，用于演示USB Host读取游戏手柄信息（这里指定了索尼PS4游戏手柄）功能。

## 注意事项

- USB 使用`12.000MHz`高精度晶振，需在工程中开启全局宏定义 `CUSTOM_HSE_VAL` 来开启。

- 启用 USB Host 时，需要通过电源开关芯片（如：SY6280AAC）来控制对USB Device 的供电，因 Mini-F5277-OB 开发板未提供 USB A 接口和电源开关芯片，这里可以将 D+(PA11)、D-(PA12) 和 EN(PC13)引脚外接至外部的 USB A 外围电路中进行测试验证，并需要将Mini-F5277-OB 开发板的SP6和SP4进行通过焊锡进行填充。

## USB术语解析

**SIE**

SIE 在 USB 驱动中是指 Serial Interface Engine，即串行接口引擎。它是 USB 外设中最关键的硬件组成部分之一。SIE 负责处理与 USB 通信协议相关的所有底层操作，包括但不限于以下功能：

1. 速度识别：识别设备的传输速度（低速、全速、高速）。
2. 包解析和构造：解析接收到的 USB 数据包，并构造要发送的数据包。
3. NRZI 编/译码和填充位操作：NRZI （Non-Return-to-Zero Inverted）是一种信号编码方式，SIE 能够进行 NRZI 编码和解码，以及添加和去除数据包中的填充位以保持时钟同步。
4. 与 USB 总线的电气接口：包括 UTMI（Universal Transceiver Macrocell Interface）或其他类似的物理层接口，用于实现与 USB 总线的电气连接和信号传输。

**OTA**

USB OTG（On-The-Go）的双角色功能是指设备能够同时扮演主机（Host）和外设（Peripheral）的角色。在传统的USB系统中，通常有一个设备作为主机，负责控制和管理数据传输，而其他设备则是外设，只能被动响应主机的请求。

然而，在USB OTG中，双角色设备（Dual-Role Device，DRD）的设计允许一个设备在不同的时间或在需要的时候切换其角色。这意味着这样的设备既可以作为主机来发起数据传输，例如从一个USB闪存驱动器读取数据，也可以作为外设与其他设备连接，如被另一台设备（可能是另一台OTG设备或者传统的主机）访问或充电。

这种灵活性使得USB OTG双角色设备在移动设备和便携式设备中特别有用，比如智能手机和平板电脑，这些设备可能需要与其他设备交换数据，或者在没有传统主机（如电脑）的情况下直接进行数据传输和供电操作。通过USB OTG的双角色支持，设备之间的交互变得更加便捷和多样化。

支持主机协商协议（HNP）和会话请求协议（SRP）是USB On-The-Go（OTG）规范中的两个关键特性。

1. 主机协商协议（HNP）： HNP允许USB OTG设备在操作过程中动态切换其角色，即从主机角色切换到外设角色，或者从外设角色切换到主机角色。这种切换是在设备之间直接进行的，无需人工干预。例如，当一个OTG设备正在作为主机与另一个设备通信，但随后希望被连接到一个更强大的主机（如电脑）时，它可以使用HNP请求将主机角色转移给新连接的设备。
2. 会话请求协议（SRP）： SRP是USB OTG中的另一个重要特性，它允许无主电源（即自身不供电的设备，通常称为A设备）启动与有主电源设备（通常称为B设备）的通信会话。在传统的USB系统中，数据传输总是由主机发起。但在USB OTG中，由于设备可以动态切换角色，因此需要一种机制让无主电源设备能够启动通信。SRP就是用于实现这一目标的协议，它允许无主电源设备通过向有主电源设备发送一个会话请求来启动数据传输。

总的来说，HNP和SRP都是为了增强USB OTG设备的灵活性和互操作性，使得设备能够根据需要动态调整其角色和行为，从而在各种不同的使用场景下提供更好的用户体验。

**USB的SE0信号**

在USB（Universal Serial Bus）协议中，SE0（Single-Ended Zero）信号是一种特殊的信号状态，它表示数据线D+和D-上的电平都为逻辑0（低电平）。

SE0信号在USB通信中扮演着重要的角色，主要用于错误检测、设备初始化和总线恢复等操作。它是确保USB总线稳定性和可靠性的关键部分。

**USB的JSTATE 信号**

USB差分接收器接收到JSTATE信号时，它通常是作为设备枚举和速度检测过程的一部分，帮助主机正确识别和配置连接的USB设备。

**STALL 中断**

STALL中断是USB协议中一种重要的错误处理和通信机制，它允许设备向主机报告无法处理请求的情况，并促使主机采取相应的措施来解决问题。通过正确处理STALL中断，可以提高USB通信的可靠性和稳定性。

**RESUME中断**

RESUME中断是USB协议中一种重要的电源管理机制，它允许设备在暂停后重新启动数据传输，并确保主机能够正确地处理设备的恢复请求。通过有效管理RESUME中断，可以提高USB设备的能效和用户体验。

## 参考文献

- USB 2.0 Specification：https://usb.org/document-library/usb-20-specification
- TinyUSB 官网：https://docs.tinyusb.org/en/latest/
- MM32F5270 UM：https://mindmotion.com.cn/download/products/UM_MM32F5270_MM32F5280_SC.pdf
- 《圈圈教你玩 USB》，刘荣，北京航空航天大学出版社，ISBN: 9787811246001












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2025 ZhangBinbin/All Rights Reserved.
    </div>
  
  
</div>
      
        <div class="md-social">
  
    
    
    
    
    <a href="https://iamzhangbinbin.github.io/" target="_blank" rel="noopener" title="Wechat" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M385.2 167.6c6.4 0 12.6.3 18.8 1.1C387.4 90.3 303.3 32 207.7 32 100.5 32 13 104.8 13 197.4c0 53.4 29.3 97.5 77.9 131.6l-19.3 58.6 68-34.1c24.4 4.8 43.8 9.7 68.2 9.7 6.2 0 12.1-.3 18.3-.8-4-12.9-6.2-26.6-6.2-40.8-.1-84.9 72.9-154 165.3-154m-104.5-52.9c14.5 0 24.2 9.7 24.2 24.4 0 14.5-9.7 24.2-24.2 24.2-14.8 0-29.3-9.7-29.3-24.2.1-14.7 14.6-24.4 29.3-24.4m-136.4 48.6c-14.5 0-29.3-9.7-29.3-24.2 0-14.8 14.8-24.4 29.3-24.4 14.8 0 24.4 9.7 24.4 24.4 0 14.6-9.6 24.2-24.4 24.2M563 319.4c0-77.9-77.9-141.3-165.4-141.3-92.7 0-165.4 63.4-165.4 141.3S305 460.7 397.6 460.7c19.3 0 38.9-5.1 58.6-9.9l53.4 29.3-14.8-48.6C534 402.1 563 363.2 563 319.4m-219.1-24.5c-9.7 0-19.3-9.7-19.3-19.6 0-9.7 9.7-19.3 19.3-19.3 14.8 0 24.4 9.7 24.4 19.3 0 10-9.7 19.6-24.4 19.6m107.1 0c-9.7 0-19.3-9.7-19.3-19.6 0-9.7 9.7-19.3 19.3-19.3 14.5 0 24.4 9.7 24.4 19.3.1 10-9.9 19.6-24.4 19.6"/></svg>
    </a>
  
    
    
    
    
    <a href="https://iamzhangbinbin.github.io/" target="_blank" rel="noopener" title="telegram" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M248 8C111.033 8 0 119.033 0 256s111.033 248 248 248 248-111.033 248-248S384.967 8 248 8m114.952 168.66c-3.732 39.215-19.881 134.378-28.1 178.3-3.476 18.584-10.322 24.816-16.948 25.425-14.4 1.326-25.338-9.517-39.287-18.661-21.827-14.308-34.158-23.215-55.346-37.177-24.485-16.135-8.612-25 5.342-39.5 3.652-3.793 67.107-61.51 68.335-66.746.153-.655.3-3.1-1.154-4.384s-3.59-.849-5.135-.5q-3.283.746-104.608 69.142-14.845 10.194-26.894 9.934c-8.855-.191-25.888-5.006-38.551-9.123-15.531-5.048-27.875-7.717-26.8-16.291q.84-6.7 18.45-13.7 108.446-47.248 144.628-62.3c68.872-28.647 83.183-33.623 92.511-33.789 2.052-.034 6.639.474 9.61 2.885a10.45 10.45 0 0 1 3.53 6.716 43.8 43.8 0 0 1 .417 9.769"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://iamzhangbinbin.github.io/" target="_blank" rel="noopener" title="iamzhangbinbin.github.io" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8l164.9-188.5L26.8 48h145.6l100.5 132.9zm-24.8 373.8h39.1L151.1 88h-42z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://iamzhangbinbin.github.io/" target="_blank" rel="noopener" title="iamzhangbinbin.github.io" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
    <a href="mailto:<z466302@126.com>" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M64 112c-8.8 0-16 7.2-16 16v22.1l172.5 141.6c20.7 17 50.4 17 71.1 0L464 150.1V128c0-8.8-7.2-16-16-16zM48 212.2V384c0 8.8 7.2 16 16 16h384c8.8 0 16-7.2 16-16V212.2L322 328.8c-38.4 31.5-93.7 31.5-132 0zM0 128c0-35.3 28.7-64 64-64h384c35.3 0 64 28.7 64 64v256c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://iamzhangbinbin.github.io/" target="_blank" rel="noopener" title="iamzhangbinbin.github.io" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M488.6 104.1c16.7 18.1 24.4 39.7 23.3 65.7v202.4c-.4 26.4-9.2 48.1-26.5 65.1-17.2 17-39.1 25.9-65.5 26.7H92.02c-26.45-.8-48.21-9.8-65.28-27.2C9.682 419.4.767 396.5 0 368.2V169.8c.767-26 9.682-47.6 26.74-65.7C43.81 87.75 65.57 78.77 92.02 78h29.38L96.05 52.19c-5.75-5.73-8.63-13-8.63-21.79 0-8.8 2.88-16.06 8.63-21.797C101.8 2.868 109.1 0 117.9 0q13.2 0 21.9 8.603L213.1 78h88l74.5-69.397C381.7 2.868 389.2 0 398 0q13.2 0 21.9 8.603c5.7 5.737 8.6 12.997 8.6 21.797 0 8.79-2.9 16.06-8.6 21.79L394.6 78h29.3c26.4.77 48 9.75 64.7 26.1m-38.8 69.7c-.4-9.6-3.7-17.4-10.7-23.5-5.2-6.1-14-9.4-22.7-9.8H96.05c-9.59.4-17.45 3.7-23.58 9.8-6.14 6.1-9.4 13.9-9.78 23.5v194.4c0 9.2 3.26 17 9.78 23.5s14.38 9.8 23.58 9.8H416.4c9.2 0 17-3.3 23.3-9.8s9.7-14.3 10.1-23.5zm-264.3 42.7c6.3 6.3 9.7 14.1 10.1 23.2V273c-.4 9.2-3.7 16.9-9.8 23.2-6.2 6.3-14 9.5-23.6 9.5s-17.5-3.2-23.6-9.5-9.4-14-9.8-23.2v-33.3c.4-9.1 3.8-16.9 10.1-23.2s13.2-9.6 23.3-10c9.2.4 17 3.7 23.3 10m191.5 0c6.3 6.3 9.7 14.1 10.1 23.2V273c-.4 9.2-3.7 16.9-9.8 23.2s-14 9.5-23.6 9.5-17.4-3.2-23.6-9.5c-7-6.3-9.4-14-9.7-23.2v-33.3c.3-9.1 3.7-16.9 10-23.2s14.1-9.6 23.3-10c9.2.4 17 3.7 23.3 10"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.instant", "navigation.instant.progress", "navigation.tracking", "navigation.tabs", "navigation.sections", "navigation.expand", "navigation.prune", "navigation.indexes", "toc.integrate", "navigation.top", "search.suggest", "search.highlight", "search.share", "header.autohide", "announce.dismiss", "content.code.copy", "content.code.annotate", "content.tabs.link", "content.tooltips"], "search": "../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
    
  </body>
</html>